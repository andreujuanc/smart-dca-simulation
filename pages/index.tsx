import type { NextPage } from 'next'
import Head from 'next/head'
import { Chart } from '../components/chart'
import styles from '../styles/Home.module.css'
import { prices } from '../data'
import { useMemo, useState } from 'react'
import { averagePriceSlope } from '../src'

const Home: NextPage = () => {
  const [pair, setPair] = useState(prices[0].id)
  const [slope, setSlope] = useState(7)
  const [slopeIntensity, setSlopeIntensity] = useState(8.4)
  const [bias, setBias] = useState(0.6)
  const [freq, setFreq] = useState(1)
  const [executeAmount, setExecuteAmount] = useState(3)
  const [savings, setSavings]= useState(30)
  const [from, setFrom] = useState<string>('2021-01-01')
  const [to, setTo] = useState<string>('2022-07-01')
  const tokenPrice = useMemo(() => (prices.find(x => x.id == pair)?.data) ?? [], [pair])

  const simResults = useMemo(()=>averagePriceSlope({
    prices: tokenPrice,
    to, from,
    dailyExecutionUSD: executeAmount,
    initialFundsUSD: savings,
    slopeLengthDAYS: slope,
    slopeIntensity: slopeIntensity,
    bias
  }), [tokenPrice, to, from, executeAmount, slope, slopeIntensity, savings, bias])

  console.log('slopeIntensity', slopeIntensity)
  return (
    <div className={styles.container}>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main className={styles.main}
        style={{
          height: '100%',
        }}
      >
        <h3 className={styles.title} style={{
          flexShrink: 1,
          flexGrow: 0
        }}>
          Smart DCA Simulation
        </h3>
        <div className={styles.card} style={{
          flexGrow: 0,
          flexShrink: 1
        }}>
          <div className={styles.formGroup}>
            <label htmlFor='pair'>Pair</label>
            <select name="pair" onChange={(e) => setPair(e.target.value)} value={pair} >
              {prices.map(({ id, name }) => (
                <option key={id} value={id} >{name}</option>
              ))}
            </select>
          </div>

          <div className={styles.formGroup}>
            <label htmlFor='savings'>Initial Savings</label>
            <input name={"savings"} value={savings} onChange={(e) => setSavings(parseInt(e.target.value))} type={"number"} min="0" max="1000000" />
          </div>

          <div className={styles.formGroup}>
            <label htmlFor='executeAmount'>Execute Amount in USD</label>
            <input name={"executeAmount"} value={executeAmount} onChange={(e) => setExecuteAmount(parseInt(e.target.value))} type={"number"} min="1" max="1000" />
          </div>

          <div className={styles.formGroup}>
            <label htmlFor='slope'>Slope AVG Days</label>
            <input name={"slope"} value={slope} onChange={(e) => setSlope(parseInt(e.target.value))} type={"number"} min="1" max="60" />
          </div>

          <div className={styles.formGroup}>
            <label htmlFor='intensity'>Intensity ({slopeIntensity})</label>
            <input name={"intensity"} value={slopeIntensity} onChange={(e) => setSlopeIntensity(parseFloat(e.target.value))} type={"range"} min="-2" max="10" step="0.1" />
          </div>

          <div className={styles.formGroup}>
            <label htmlFor='bias'>Bias ({bias})</label>
            <input name={"bias"} value={bias} onChange={(e) => setBias(parseFloat(e.target.value))} type={"range"} min="-1" max="1" step="0.01" />
          </div>

          {/* FREQ NOT YET IMPLEMENTED <div className={styles.formGroup}>
            <label htmlFor='freq'>Freq</label>
            <input name={"freq"} value={freq} onChange={(e) => setFreq(parseInt(e.target.value))} type={"number"} />
          </div> */}
  

          <div className={styles.formGroup}>
            <label htmlFor='from'>Range</label>
            <input name={"from"} value={from} onChange={(e) => setFrom(e.target.value)} type={"date"} />
            <input name={"to"} value={to} onChange={(e) => setTo(e.target.value)} type={"date"} />
          </div>
        </div>
        <div
          style={{
            flexGrow: 1,
            width: '100%',
            height: '100%'
          }}>
          <Chart
            tokenPrice={simResults.data.map(x => ({ date: x.date, price: x.price }))}
            classicDCAValue={simResults.data.map(x => x.portfolioValueUSDCLASSIC)}
            smartDCAValue={simResults.data.map(x => x.portfolioValueUSDSMART)}
            smartUSDAtHand={simResults.data.map(x => x.usdAtHand)}
            usdSavingsAccountValue={simResults.data.map(x => x.ifHoldUSDInstead)}

            classicDCAHolding={simResults.data.map(x => x.tokenAmountCLASSIC)}
            smartDCAHolding={simResults.data.map(x => x.tokenAmountSMART)}

            slope={simResults.data.map(x => x.slope)}
            averagePrice={simResults.data.map(x => x.pastAVG)}
          />
        </div>
      </main>

    </div>
  )
}

export default Home
